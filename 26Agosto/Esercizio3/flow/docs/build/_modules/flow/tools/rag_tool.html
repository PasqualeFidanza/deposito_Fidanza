<!DOCTYPE html>

<html lang="it" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>flow.tools.rag_tool &#8212; Documentazione Flow CrewAI 0.1.0 </title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=670d9c77"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=45930005"></script>
    <link rel="index" title="Indice" href="../../../genindex.html" />
    <link rel="search" title="Cerca" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Codice sorgente per flow.tools.rag_tool</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Modulo per il RagTool - Strumento CrewAI per Retrieval-Augmented Generation.</span>

<span class="sd">Questo modulo implementa un tool CrewAI che utilizza tecniche di RAG per rispondere</span>
<span class="sd">alle domande basandosi su documenti locali. Il tool carica documenti, crea embeddings,</span>
<span class="sd">costruisce un indice FAISS e utilizza un LLM per generare risposte contestualizzate.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">crewai.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">AzureOpenAIEmbeddings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">init_chat_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.vectorstores</span><span class="w"> </span><span class="kn">import</span> <span class="n">FAISS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.document_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatPromptTemplate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.output_parsers</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrOutputParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunnablePassthrough</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<div class="viewcode-block" id="RagTool">
<a class="viewcode-back" href="../../../modules.html#flow.tools.rag_tool.RagTool">[documenti]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RagTool</span><span class="p">(</span><span class="n">BaseTool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tool CrewAI per Retrieval-Augmented Generation (RAG) con persistenza FAISS.</span>
<span class="sd">    </span>
<span class="sd">    Questo tool implementa un sistema RAG completo che:</span>
<span class="sd">    1. Carica documenti locali (.txt, .md) da una directory specificata</span>
<span class="sd">    2. Crea embeddings utilizzando Azure OpenAI</span>
<span class="sd">    3. Costruisce e persiste un indice FAISS per la ricerca semantica</span>
<span class="sd">    4. Utilizza un LLM per generare risposte basate sui documenti recuperati</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        name (str): Nome del tool</span>
<span class="sd">        description (str): Descrizione del tool per CrewAI</span>
<span class="sd">        documents_path (str): Percorso della directory contenente i documenti</span>
<span class="sd">        persist_dir (Path): Directory per la persistenza dell&#39;indice FAISS</span>
<span class="sd">        embeddings (Optional[AzureOpenAIEmbeddings]): Modello di embeddings</span>
<span class="sd">        llm (Optional[object]): Modello linguistico per la generazione</span>
<span class="sd">        vector_store (Optional[FAISS]): Store vettoriale FAISS</span>
<span class="sd">        retriever (Optional[object]): Retriever per la ricerca semantica</span>
<span class="sd">        chain (Optional[object]): Catena LangChain per RAG</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RAG Tool&quot;</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Uno strumento CrewAI che implementa Retrieval-Augmented Generation (RAG) &quot;</span>
        <span class="s2">&quot;con persistenza FAISS su disco. Carica documenti locali (.txt, .md), &quot;</span>
        <span class="s2">&quot;e risponde alle domande citando le fonti.&quot;</span>
    <span class="p">)</span>

    <span class="n">load_dotenv</span><span class="p">()</span>

    <span class="c1"># Campi input Pydantic</span>
    <span class="n">documents_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;docs&quot;</span><span class="p">)</span>
    <span class="n">persist_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;faiss_index_docs&quot;</span><span class="p">))</span>

    <span class="n">embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AzureOpenAIEmbeddings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vector_store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FAISS</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">retriever</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">chain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RagTool.__init__">
<a class="viewcode-back" href="../../../modules.html#flow.tools.rag_tool.RagTool.__init__">[documenti]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inizializza il RagTool configurando embeddings, LLM e sistema RAG.</span>
<span class="sd">        </span>
<span class="sd">        Durante l&#39;inizializzazione:</span>
<span class="sd">        1. Configura gli embeddings Azure OpenAI</span>
<span class="sd">        2. Configura il modello linguistico</span>
<span class="sd">        3. Testa le connessioni</span>
<span class="sd">        4. Carica o costruisce l&#39;indice FAISS</span>
<span class="sd">        5. Crea la catena RAG</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            **data: Dati di configurazione per Pydantic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 1️⃣ Embeddings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">AzureOpenAIEmbeddings</span><span class="p">(</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_KEY&quot;</span><span class="p">),</span>
            <span class="n">azure_endpoint</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_BASE&quot;</span><span class="p">),</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_VERSION&quot;</span><span class="p">),</span>
            <span class="n">model</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EMBEDDING_MODEL&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># 2️⃣ LLM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">init_chat_model</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LLM_MODEL&quot;</span><span class="p">),</span>
            <span class="n">model_provider</span><span class="o">=</span><span class="s2">&quot;azure_openai&quot;</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_KEY&quot;</span><span class="p">),</span>
            <span class="n">api_version</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_VERSION&quot;</span><span class="p">),</span>
            <span class="n">azure_endpoint</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_API_BASE&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Test embedding: genera embedding per una stringa di esempio</span>
            <span class="n">test_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connessione embedding OK&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Errore embedding:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test LLM: genera una risposta di esempio</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="s2">&quot;Ciao!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connessione LLM OK&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Errore LLM:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># 3️⃣ Carica o costruisce FAISS</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_documents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_or_build_vectorstore</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_retriever</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector_store</span><span class="p">)</span>

        <span class="c1"># 4️⃣ Catena RAG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_chain</span><span class="p">()</span></div>



    <span class="k">def</span><span class="w"> </span><span class="nf">_load_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Carica tutti i documenti dalla directory specificata.</span>
<span class="sd">        </span>
<span class="sd">        Scansiona ricorsivamente la directory documents_path e carica tutti i file</span>
<span class="sd">        con estensione .txt e .md, aggiungendo metadati sulla fonte.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: Lista dei documenti caricati</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">documents_path</span><span class="p">)</span>
        <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;.md&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="n">TextLoader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
                <span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
            <span class="n">documents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">documents</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_split_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Suddivide i documenti in chunk più piccoli per l&#39;indicizzazione.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            docs (List[Document]): Lista dei documenti da suddividere</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: Lista dei chunk di documenti</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_vectorstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FAISS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Costruisce un nuovo indice FAISS dai chunk di documenti.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            chunks (List[Document]): Chunk di documenti da indicizzare</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            FAISS: Store vettoriale FAISS costruito e salvato</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">FAISS</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vs</span><span class="o">.</span><span class="n">save_local</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persist_dir</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_or_build_vectorstore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FAISS</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Carica un indice FAISS esistente o ne costruisce uno nuovo.</span>
<span class="sd">        </span>
<span class="sd">        Se l&#39;indice esiste già, lo carica. Altrimenti, suddivide i documenti</span>
<span class="sd">        e costruisce un nuovo indice.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            docs (List[Document]): Documenti da indicizzare se necessario</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            FAISS: Store vettoriale FAISS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persist_dir</span> <span class="o">/</span> <span class="s2">&quot;index.faiss&quot;</span>
        <span class="n">meta_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persist_dir</span> <span class="o">/</span> <span class="s2">&quot;index.pkl&quot;</span>
        <span class="k">if</span> <span class="n">index_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">meta_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">FAISS</span><span class="o">.</span><span class="n">load_local</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">persist_dir</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">,</span>
                <span class="n">allow_dangerous_deserialization</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_vectorstore</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_retriever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_store</span><span class="p">:</span> <span class="n">FAISS</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crea un retriever dal store vettoriale FAISS.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            vector_store (FAISS): Store vettoriale da cui creare il retriever</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            object: Retriever configurato per recuperare i 5 documenti più rilevanti</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">vector_store</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(</span><span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_format_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formatta i documenti recuperati per il prompt del LLM.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            docs (List[Document]): Documenti da formattare</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Documenti formattati con informazioni sulla fonte</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;[source:</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">page_content</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Costruisce la catena LangChain per il sistema RAG.</span>
<span class="sd">        </span>
<span class="sd">        La catena combina:</span>
<span class="sd">        1. Recupero dei documenti rilevanti</span>
<span class="sd">        2. Formattazione del contesto</span>
<span class="sd">        3. Prompt engineering</span>
<span class="sd">        4. Generazione della risposta con LLM</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            object: Catena LangChain configurata per RAG</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Sei un assistente esperto. Rispondi in italiano. &quot;</span>
            <span class="s2">&quot;Usa solo le informazioni nei documenti forniti. &quot;</span>
            <span class="s2">&quot;Se non trovi la risposta, scrivi: &#39;Non è presente nel contesto fornito.&#39;&quot;</span>
        <span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;Domanda:</span><span class="se">\n</span><span class="si">{question}</span><span class="se">\n\n</span><span class="s2">Contesto:</span><span class="se">\n</span><span class="si">{context}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="n">chain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">RunnablePassthrough</span><span class="p">(),</span>
                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_docs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">get_relevant_documents</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="n">prompt</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>
            <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">chain</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Esegue la query attraverso il sistema RAG.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query (str): Domanda dell&#39;utente</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: Risposta generata dal sistema RAG</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Flow CrewAI</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigazione</h3>
<p class="caption" role="heading"><span class="caption-text">Documentazione API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Moduli del Progetto</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Codice del modulo</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Your Name.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>